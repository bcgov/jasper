<template>
  <div class="d-flex justify-center align-center my-3">
    <div class="calendar-toggle text-left">
      <a
        href="#"
        data-testid="calendar-toggle-link"
        class="text-decoration-underline cursor-pointer"
        @click="isCourtCalendar = !isCourtCalendar"
      >
        <v-icon :icon="isCourtCalendar ? mdiChevronLeft : mdiChevronRight" />
        {{ isCourtCalendar ? 'View My Calendar' : 'View Other Calendars' }}
      </a>
    </div>
    <div class="d-flex align-center centered">
      <div class="d-flex align-center">
        <v-icon
          class="previous cursor-pointer"
          :icon="mdiChevronLeft"
          size="32"
          @click.stop="() => previous(calendarView)"
          :disabled="isCalendarLoading"
        />
        <h3 data-testid="title" class="m-0">
          Schedule for {{ formatDateInstanceToMMMYYYY(selectedDate!) }}
        </h3>
        <v-icon
          class="next cursor-pointer"
          :icon="mdiChevronRight"
          size="32"
          @click.stop="() => next(calendarView)"
          :disabled="isCalendarLoading"
        />
      </div>
      <div class="d-flex align-center centered">
        <!-- Month picker for My Calendar -->
        <v-menu
          v-if="!isCourtCalendar"
          data-testid="month-picker"
          location="bottom end"
          class="mr-3"
        >
          <template v-slot:activator="{ props }">
            <v-icon
              :icon="mdiChevronDown"
              v-bind="props"
              class="mr-3"
              :disabled="isCalendarLoading"
            />
          </template>
          <div class="d-flex flex-column month-picker">
            <div class="d-flex flex-row justify-center mt-3">
              <v-icon
                :icon="mdiChevronLeft"
                data-testid="previous-button"
                @click.stop="() => previous('')"
                :disabled="isCalendarLoading"
              />
              <span class="mx-3">{{ selectedYear }}</span>
              <v-icon
                :disabled="isCalendarLoading"
                :icon="mdiChevronRight"
                @click.stop="() => next('')"
                data-testid="next-button"
              />
            </div>
            <v-date-picker
              :view-mode="viewMode"
              type="month"
              v-model="selectedDate"
              @update:view-mode="updateViewMode"
              @update:month="updateMonth"
              hide-header
            />
          </div>
        </v-menu>
        <!-- Date Picker for Court Calendar -->
        <v-date-input
          v-else
          data-testid="date-picker"
          class="cc-date-picker mx-3"
          hide-details
          label=""
          density="compact"
          v-model="selectedDate"
          :disabled="isCalendarLoading"
        >
          <template v-slot:default="">
            <v-icon :icon="mdiCalendarMonthOutline" />
          </template>
        </v-date-input>
        <v-btn-secondary
          text="Today"
          size="large"
          class="mr-3"
          data-testid="today-button"
          @click="today"
          density="comfortable"
          :disabled="isCalendarLoading"
        ></v-btn-secondary>
        <!-- Calendar View Picker for Court Calendar -->
        <v-menu
          v-if="isCourtCalendar"
          data-testid="calendar-view-picker"
          v-model="menuOpen"
          location="bottom end"
        >
          <template #activator="{ props }">
            <v-btn
              v-bind="props"
              variant="outlined"
              density="default"
              :disabled="isCalendarLoading"
            >
              <component
                class="mr-2"
                :is="currentOption?.icon"
                width="24"
                height="24"
              />
              <span>{{ currentOption?.label }}</span>
              <v-icon :icon="mdiChevronDown" v-bind="props" />
            </v-btn>
          </template>

          <v-list>
            <v-list-item
              v-for="(option, i) in options"
              :key="i"
              @click="selectOption(option)"
            >
              <v-list-item-title class="d-flex align-center">
                <component
                  :is="option.icon"
                  class="mr-2"
                  width="24"
                  height="24"
                />
                {{ option.label }}
              </v-list-item-title>
            </v-list-item>
          </v-list>
        </v-menu>
      </div>
    </div>
    <div class="more text-right">
      <a class="text-decoration-underline cursor-pointer"
        ><v-icon :icon="mdiDotsHorizontal" />More</a
      >
    </div>
  </div>
</template>
<script setup lang="ts">
  import MonthIcon from '@/assets/month.svg';
  import OneWeekIcon from '@/assets/one-week.svg';
  import TwoWeekIcon from '@/assets/two-week.svg';
  import { CalendarViewEnum } from '@/types/common';
  import { formatDateInstanceToMMMYYYY } from '@/utils/dateUtils';
  import {
    mdiCalendarMonthOutline,
    mdiChevronDown,
    mdiChevronLeft,
    mdiChevronRight,
    mdiDotsHorizontal,
  } from '@mdi/js';
  import { computed, ref, watch } from 'vue';
  import { DateTime } from 'luxon';

  const selectedDate = defineModel<Date>('selectedDate');
  const isCourtCalendar = defineModel<boolean>('isCourtCalendar');
  const calendarView = defineModel<string>('calendarView');

  const props = defineProps<{ isCalendarLoading: boolean }>();

  const viewMode = ref<'months' | 'year' | 'month' | undefined>('months');
  const selectedYear = ref(
    selectedDate.value
      ? selectedDate.value.getFullYear()
      : new Date().getFullYear()
  );
  const selectedMonth = ref(
    selectedDate.value ? selectedDate.value.getMonth() : new Date().getMonth()
  );
  const isLocalDisabled = ref(true);

  const options = [
    { label: 'Month', value: CalendarViewEnum.MonthView, icon: MonthIcon },
    { label: '2 Week', value: CalendarViewEnum.TwoWeekView, icon: TwoWeekIcon },
    { label: 'Week', value: CalendarViewEnum.WeekView, icon: OneWeekIcon },
  ];

  const currentOption = computed(() =>
    options.find((o) => o.value === calendarView.value)
  );

  const menuOpen = ref(false);

  const selectOption = (option) => {
    calendarView.value = option.value;
    menuOpen.value = false;
  };

  const updateViewMode = (mode) =>
    (viewMode.value = mode === 'year' ? 'year' : 'months');

  const setDate = (date: Date) => {
    selectedYear.value = date.getFullYear();
    selectedMonth.value = date.getMonth();
    selectedDate.value = date;
  };

  const changeDate = (offset: number, viewMode: CalendarViewEnum) => {
    let newDateTime = DateTime.fromJSDate(selectedDate.value);

    switch (viewMode) {
      case CalendarViewEnum.WeekView:
        newDateTime = newDateTime.plus({ weeks: offset });
        break;
      case CalendarViewEnum.TwoWeekView:
        newDateTime = newDateTime.plus({ weeks: offset * 2 });
        break;
      case CalendarViewEnum.MonthView:
        newDateTime = newDateTime.plus({ months: offset });
        break;
      default:
        newDateTime = newDateTime.plus({ years: offset });
        break;
    }

    setDate(newDateTime.toJSDate());
  };

  const previous = (viewMode: CalendarViewEnum) => changeDate(-1, viewMode);
  const next = (viewMode: CalendarViewEnum) => changeDate(1, viewMode);

  const today = () => setDate(new Date());

  const updateMonth = (month: number) => {
    setDate(new Date(selectedYear.value, month, 1));
  };
</script>
<style scoped>
  /* Common Styles*/
  .calendar-toggle,
  .more {
    flex: 1;
    color: var(--text-blue-500);
  }

  .calendar-toggle:hover,
  .more:hover {
    color: var(--text-blue-800);
  }

  /* My Schedule Controls Styles */
  :deep(.v-picker__body .v-date-picker-controls) {
    display: none;
  }

  :deep(.v-date-picker-months) {
    height: 10rem;
  }

  :deep(.v-date-picker-months__content) {
    border-bottom-left-radius: 1.25rem;
    border-bottom-right-radius: 1.25rem;
    box-shadow: 0px 0px 5px 0px rgba(0, 0, 0, 0.2);
    grid-template-columns: repeat(4, 1fr);
    grid-gap: 0;
    padding-inline-start: 0;
    padding-inline-end: 0;
  }

  :deep(.v-date-picker-months__content .v-btn) {
    border-radius: 0px;
    background-color: var(--bg-gray-200);
    margin: 0.5rem;
  }

  :deep(.v-date-picker-months__content .v-btn:hover) {
    border-radius: 0px;
    font-weight: bold;
    margin: 0.5rem;
  }

  :deep(.v-date-picker-months__content .v-btn--active .v-btn__overlay) {
    background-color: var(--bg-white-500) !important;
  }

  :deep(.v-date-picker-months__content .v-btn--active) {
    border: 1px solid var(--border-blue-500);
    border-radius: 0px;
    font-weight: bold;
  }

  :deep(.v-date-picker-months__content .v-btn__content) {
    text-transform: uppercase;
  }

  .month-picker {
    box-shadow: 0px 0px 5px 0px rgba(0, 0, 0, 0.2);
    border-radius: 1.25rem;
    background-color: var(--bg-white-500);
  }

  /* Court Calendar Controls Styles */
  :deep(.cc-date-picker .v-field__field) {
    width: 175px !important;
  }

  :deep(.cc-date-picker .v-input__prepend) {
    display: none;
  }

  .two-week-svg {
    width: 22px;
    height: 22px;
  }

  .previous:hover,
  .next:hover {
    opacity: 0.8;
  }
</style>
