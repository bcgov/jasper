<template>
  <Teleport
    :to="`.fc-expand-wrapper[data-date='${day.date}']`"
    v-if="expandedDate === day.date"
  >
    <div class="pa-2 expanded-content">
      <div class="header d-flex align-center justify-space-between">
        <span>{{ dayNumberText }}</span>
        <RouterLink :to="{ name: 'CourtList', query: { date: day.date } }">
          <v-icon v-if="day.showCourtList" :icon="mdiListBoxOutline" />
        </RouterLink>
      </div>
      <div class="d-flex flex-column">
        <div
          v-for="(
            { locationName, activities, showVideo }, index
          ) in groupedActivities"
        >
          <div class="mb-2 d-flex">
            <span data-testid="name">{{ locationName }}</span>
            <v-icon
              data-testid="location-remote-icon"
              v-if="showVideo"
              :icon="mdiVideo"
            />
          </div>
          <div
            class="d-flex flex-column mb-1"
            v-for="{
              period,
              activityClassDescription,
              activityDescription,
              roomCode,
              isRemote,
              showDars,
              restrictions,
            } in activities"
          >
            <div class="d-flex justify-space-between">
              <div class="d-flex align-center">
                <v-chip
                  size="small"
                  density="compact"
                  class="period mr-1"
                  v-if="period"
                  >{{ period }}</v-chip
                >
                <div
                  :class="
                    cleanActivityClassDescription(activityClassDescription)
                  "
                >
                  <span data-testid="activity">
                    {{ activityDescription }}
                  </span>
                  <span v-if="roomCode" data-testid="room">
                    ({{ roomCode }})</span
                  >
                </div>
              </div>
              <div>
                <v-icon v-if="showDars" :icon="mdiHeadphones" />
                <v-icon
                  data-testid="activity-remote-icon"
                  v-if="!showVideo && isRemote"
                  :icon="mdiVideo"
                />
              </div>
            </div>
            <div
              v-if="restrictions && restrictions.length > 0"
              class="d-flex flex-column justify-start mt-2 continuations"
            >
              <span><b>Continuations:</b></span>
              <a
                v-for="{ fileName, fileId, isCivil } in restrictions"
                :href="`/${isCivil ? 'civil' : 'criminal'}-file/${fileId}`"
                target="_blank"
                rel="noopener"
                >{{ fileName }}</a
              >
            </div>
          </div>

          <hr v-if="index + 1 < groupedActivities.length" />
        </div>
      </div>
    </div>
  </Teleport>
</template>
<script setup lang="ts">
  import { CalendarDay, CalendarDayActivity } from '@/types';
  import { parseDDMMMYYYYToDate } from '@/utils/dateUtils';
  import { mdiHeadphones, mdiListBoxOutline, mdiVideo } from '@mdi/js';
  import { computed } from 'vue';

  const props = defineProps<{
    expandedDate: string | null;
    day: CalendarDay;
  }>();

  const cleanActivityClassDescription = (
    activityClassDescription: string
  ): string => {
    return activityClassDescription.trim().replace(/\s+/g, '-').toLowerCase();
  };

  const dayNumberText = computed(() => {
    const parsedDate = parseDDMMMYYYYToDate(props.day.date);
    return parsedDate?.getDate();
  });

  const groupedActivities = computed(() => {
    const data = new Map<string, CalendarDayActivity[]>();

    for (const activity of props.day.activities) {
      if (!data.has(activity.locationName)) {
        data.set(activity.locationName, []);
      }
      data.get(activity.locationName)?.push(activity);
    }

    return Array.from(data.entries()).map(([locationName, activities]) => ({
      locationName,
      showVideo: activities.every((a) => a.isRemote),
      activities,
    }));
  });
</script>
<style scoped>
  .expanded-content {
    position: absolute;
    width: 300px;
    top: 0;
    left: 0;
    z-index: 10;
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
    border: 2px solid var(--border-blue-500);
    font-size: 0.9375rem !important;
  }

  .period {
    color: var(--text-white-500);
    background-color: var(--bg-blue-800);
  }

  .header span {
    color: var(--text-blue-800);
    font-weight: bold;
    font-size: 1rem;
  }

  .header a {
    color: var(--text-blue-800);
    text-decoration: none;
  }

  .continuations a {
    color: var(--text-blue-500);
    text-decoration: underline;
  }

  .continuations a:hover {
    color: var(--text-blue-500);
    text-decoration: none;
  }
</style>
